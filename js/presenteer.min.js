/**
* Presenteer class
* @author Willem Mulder
*
* Note: don't use element-rotates of 90 or 270 degrees in combination with element-translates. 
* A bug in the Sylvester matrix libs will set the horizontal translation to 0 when you do this
*/
function Presenteer(canvas,elements,options){function cancelFullScreen(){if(fullScreenSupport){if(document.cancelFullScreen){document.cancelFullScreen()}else if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else if(document.oCancelFullScreen){document.oCancelFullScreen()}}else{$("#presenteerjsfullscreenbackground").remove();$(fullScreenElement).attr("style",fullScreenBackupStyling||"")}isFullScreen=false}function fullScreen(a){if(typeof a=="undefined"){fullScreenElement=$(canvas).parent().get(0)}else{fullScreenElement=$(a).get(0)}if(fullScreenSupport){if(fullScreenElement.requestFullScreen){fullScreenElement.requestFullScreen()}else if(fullScreenElement.mozRequestFullScreen){fullScreenElement.mozRequestFullScreen();fullScreenElement.mozfullscreenerror=function(){isFullScreen=false;return}}else if(fullScreenElement.webkitRequestFullScreen){fullScreenElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT)}else if(fullScreenElement.oRequestFullScreen){fullScreenElement.oRequestFullScreen()}}else{$("body").append("<div id='presenteerjsfullscreenbackground' style='position: fixed; background: #000; left: 0px; top: 0px; right: 0px; bottom: 0px;'></div>");fullScreenBackupStyling=$(fullScreenElement).attr("style");$(fullScreenElement).attr("style",fullScreenBackupStyling+"; position: fixed; z-index: 1000; left: 0px; top: 0px; right: 0px; bottom: 0px;")}isFullScreen=true}function toggleFullScreen(a){if(isFullScreen===false){if(typeof a=="undefined"){var a=$(canvas).parent().get(0)}fullScreen()}else{cancelFullScreen()}}function outerScrollWidth(a,b){if($.browser.mozilla||$.browser.opera){var c=$(a).get(0).scrollWidth;var d=$(a).get(0).style.overflow;$(a).get(0).style.overflow="scroll"}var e=$(a).get(0).scrollWidth;if($.browser.mozilla||$.browser.opera){if(c>e){e=c}$(a).get(0).style.overflow=d}e+=$(a).outerWidth(b)-$(a).innerWidth();return e}function outerScrollHeight(a,b){if($.browser.mozilla||$.browser.opera){var c=$(a).get(0).scrollHeight;var d=$(a).get(0).style.overflow;$(a).get(0).style.overflow="scroll"}var e=$(a).get(0).scrollHeight;if($.browser.mozilla||$.browser.opera){if(c>e){e=c}$(a).get(0).style.overflow=d}e=e+($(a).outerHeight(b)-$(a).innerHeight());return e}function processElementTransforms(elm){var matrix="";for(var prefixID in prefixes){var prefix=prefixes[prefixID];if($(elm).css(prefix+"Transform")!=null&&$(elm).css(prefix+"Transform").indexOf("matrix")===0){var matrix=$(elm).css(prefix+"Transform");break}}if(matrix!=""){var sylvesterMatrixString=matrix.replace(/matrix\((.+)\, (.+)\, (.+)\, (.+)\, (.+?)p?x?\, (.+?)p?x?\)/,"$M([[$1,$3,$5],[$2,$4,$6],[0,0,1]])");var sylvesterMatrix=eval(sylvesterMatrixString);var inverseMatrix=sylvesterMatrix.inverse();var inverseMatrixString="";if(inverseMatrix!=null){inverseMatrixString="matrix("+Math.round(inverseMatrix.e(1,1)*1e8)/1e8+", "+Math.round(inverseMatrix.e(2,1)*1e8)/1e8+", "+Math.round(inverseMatrix.e(1,2)*1e8)/1e8+", "+Math.round(inverseMatrix.e(2,2)*1e8)/1e8+", "+Math.round(inverseMatrix.e(1,3)*1e8)/1e8+", "+Math.round(inverseMatrix.e(2,3)*1e8)/1e8+""+")"}return inverseMatrixString}return""}function addTransformation(a,b){$(a).get(0).style.MozTransform+=b;$(a).get(0).style.WebkitTransform+=b;$(a).get(0).style.OTransform+=b;$(a).get(0).style.msTransform+=b;$(a).get(0).style.transform+=b}function setTransformation(a,b){for(var c in prefixes){var d=prefixes[c];$(a).css(d+"Transform",b)}}function getTransformation(a){return $(a).get(0).style.WebkitTransform||$(a).get(0).style.MozTransform||$(a).get(0).style.OTransform||$(a).get(0).style.msTransform||$(a).get(0).style.transform||""}function setTransformOrigin(a,b,c){for(var d in prefixes){var e=prefixes[d];$(a).css(e+"TransformOrigin",b+" "+c)}}function getTransitionString(a){for(var b in a){var c=a[b];var d=false;if(c["transition-duration"]!=""&&c["transition-duration"]!="0"&&c["transition-duration"]!="0s"&&c["transition-duration"]!=null){return c["transition-property"]+" "+c["transition-duration"]+" "+c["transition-timing-function"]}}return""}function setTransitions(a,b){var c=$(a);for(var d in prefixes){var e=prefixes[d];var f=b[d]||{};c.css(e+"TransitionDelay",f["transition-delay"]||b["transition-delay"]||"0s");c.css(e+"TransitionDuration",f["transition-duration"]||b["transition-duration"]||"0s");c.css(e+"TransitionProperty",f["transition-property"]||b["transition-property"]||"none");c.css(e+"TransitionTimingFunction",f["transition-timing-function"]||b["transition-timing-function"]||"")}}function getTransitions(a){var b={};var c=$(a);for(var d in prefixes){var e=prefixes[d];var f=b[d]={};f["transition-delay"]=c.css(e+"TransitionDelay");f["transition-duration"]=c.css(e+"TransitionDuration");f["transition-property"]=c.css(e+"TransitionProperty");f["transition-timing-function"]=c.css(e+"TransitionTimingFunction")}return b}function show(a){var b=$(a.element);var c=getTransitions(canvas);setTransitions(canvas,{});var d=getTransitions(b);setTransitions(b,{});var e=getTransformation(canvas);setTransformation(canvas,"none");var f=getTransformation(b);setTransformation(b,"none");canvasZoomFactor=1;var g=b.offset().left-canvas.offset().left;var h=b.offset().top-canvas.offset().top;var i=canvas.outerWidth(options.showOriginalMargins);var j=canvas.outerHeight(options.showOriginalMargins);var k=canvas.parent().outerWidth();var l=canvas.parent().outerHeight();var m=b.outerWidth(options.showOriginalMargins)/k;var n=b.outerHeight(options.showOriginalMargins)/l;var o=Math.max(m,n);canvasZoomFactor=1/o;var p=(g-b.outerWidth(options.showOriginalMargins)*(canvasZoomFactor-1)/2)*-1;var q=(h-b.outerHeight(options.showOriginalMargins)*(canvasZoomFactor-1)/2)*-1;if(m>n){if(options.centerVertically){var r=l-b.outerHeight(options.showOriginalMargins)*canvasZoomFactor;q+=r/2}}else{if(options.centerHorizontally){var r=k-b.outerWidth(options.showOriginalMargins)*canvasZoomFactor;p+=r/2}}if(options.centerVertically&&outerScrollHeight(canvas,options.showOriginalMargins)*canvasZoomFactor<l){if(!$.browser.webkit){q=(l-outerScrollHeight(canvas,options.showOriginalMargins)*canvasZoomFactor)/2}}if(options.centerHorizontally&&outerScrollWidth(canvas,options.showOriginalMargins)*canvasZoomFactor<k){p=(k-outerScrollWidth(canvas,options.showOriginalMargins)*canvasZoomFactor)/2}var s=g*1+b.outerWidth()/2+"px";var t=h*1+b.outerHeight()/2+"px";setTransformation(canvas,e);setTransformation(b,f);setTimeout(function(){var a=getTransitionString(c);if(a!=""&&options.useExistingTransitionIfAvailable){setTransitions(canvas,c)}else{setTransitions(canvas,options.transition)}setTransitions(b,d);var e=options.followElementTransforms?processElementTransforms(b):"";var f=" translate("+p+"px,"+q+"px)  scale("+canvasZoomFactor+") "+e;setTransformOrigin(canvas,s,t);setTransformation(canvas,f)},1)}var canvas=$(canvas);if(canvas.size()==0){return false}setTransformOrigin(canvas,0,0);var canvasZoomFactor=1;var originalElements=elements;var elements=[];$.each(originalElements,function(a,b){if(b.nodeType==1){elements.push({element:$(b)})}else if(typeof b=="string"){elements.push({element:$(b)})}else{elements.push(b)}});var currentIndex=-1;var prevIndex=-1;var fullScreenSupport=document.documentElement.requestFullScreen||document.documentElement.mozRequestFullScreen||document.documentElement.webkitRequestFullScreen||document.documentElement.oRequestFullScreen;var isFullScreen=false;var realign=function(){setTimeout(function(){show(elements[currentIndex])},10)};document.addEventListener("mozfullscreenchange",function(){if(typeof mozFullScreenElement=="undefined"){isFullScreen=false}realign()});document.addEventListener("webkitfullscreenchange",function(){if(typeof webkitFullScreenElement=="undefined"){isFullScreen=false}realign()});document.addEventListener("ofullscreenchange",function(){if(typeof oFullScreenElement=="undefined"){isFullScreen=false}realign()});$(document).on("keyup",function(a){if(a.which=="27"){cancelFullScreen();realign()}});var fullScreenElement;var fullScreenBackupStyling;var optionDefaults={showOriginalMargins:false,centerHorizontally:true,centerVertically:true,followElementTransforms:true,transition:{"transition-delay":"0s","transition-duration":"0.5s","transition-property":"all","transition-timing-function":"ease"},useExistingTransitionIfAvailable:true,onBeforeEnter:function(a){},onAfterEnter:function(a){},onBeforeLeave:function(a){},onAfterLeave:function(a){}};if(typeof options!="object"){options={}}for(index in optionDefaults){if(typeof options[index]=="undefined"){options[index]=optionDefaults[index]}}var prefixes={moz:"Moz",webkit:"Webkit",o:"O",ms:"ms",all:""};return{start:function(){currentIndex=0;this.showCurrent()},restart:function(){prevIndex=currentIndex;currentIndex=0;this.showCurrent()},show:function(a){prevIndex=currentIndex;currentIndex=a;this.showCurrent()},next:function(){prevIndex=currentIndex;currentIndex++;if(currentIndex>elements.length-1){currentIndex=0}this.showCurrent()},prev:function(){prevIndex=currentIndex;currentIndex--;if(currentIndex<0){currentIndex=elements.length-1}this.showCurrent()},previous:function(){this.prev()},showCurrent:function(){if(prevIndex<currentIndex){if(elements[prevIndex]&&typeof elements[prevIndex].onBeforeLeaveToNext=="function"){elements[prevIndex].onBeforeLeaveToNext()}if(typeof elements[currentIndex].onBeforeEnterFromPrev=="function"){elements[currentIndex].onBeforeEnterFromPrev()}}if(prevIndex>currentIndex){if(elements[prevIndex]&&typeof elements[prevIndex].onBeforeLeaveToPrev=="function"){elements[prevIndex].onBeforeLeaveToPrev()}if(typeof elements[currentIndex].onBeforeEnterFromNext=="function"){elements[currentIndex].onBeforeEnterFromNext()}}if(elements[prevIndex]&&typeof elements[prevIndex].onBeforeLeave=="function"){elements[prevIndex].onBeforeLeave()}if(typeof elements[currentIndex].onBeforeEnter=="function"){elements[currentIndex].onBeforeEnter()}if(elements[prevIndex]){options.onBeforeLeave(elements[prevIndex])}options.onBeforeEnter(elements[currentIndex]);show(elements[currentIndex]);if(prevIndex<currentIndex){if(elements[prevIndex]&&typeof elements[prevIndex].onAfterLeaveToNext=="function"){elements[prevIndex].onAfterLeaveToNext()}if(typeof elements[currentIndex].onAfterEnterFromPrev=="function"){elements[currentIndex].onAfterEnterFromPrev()}}if(prevIndex>currentIndex){if(typeof elements[prevIndex].onAfterLeaveToPrev=="function"){elements[prevIndex].onAfterLeaveToPrev()}if(typeof elements[currentIndex].onAfterEnterFromNext=="function"){elements[currentIndex].onAfterEnterFromNext()}}if(elements[prevIndex]&&typeof elements[prevIndex].onAfterLeave=="function"){elements[prevIndex].onAfterLeave()}if(typeof elements[currentIndex].onAfterEnter=="function"){elements[currentIndex].onAfterEnter()}if(elements[prevIndex]){options.onAfterLeave(elements[prevIndex])}options.onAfterEnter(elements[currentIndex])},getCanvas:function(){return $(canvas)},getCurrentIndex:function(){return currentIndex},getPrevIndex:function(){return prevIndex},toggleFullScreen:function(a){toggleFullScreen(a);show(elements[currentIndex])},fullScreen:function(a){fullScreen(a);show(elements[currentIndex])},cancelFullScreen:function(){cancelFullScreen();show(elements[currentIndex])},isFullScreen:function(){return isFullScreen}}}